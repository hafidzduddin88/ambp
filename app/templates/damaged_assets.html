{% extends "layouts/modern_layout.html" %}

{% block title %}Damaged Assets{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    .asset-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .asset-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    .filter-bar {
        background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
        color: white;
    }
    .tab-button {
        transition: all 0.2s ease;
    }
    .tab-button.active {
        background-color: #EF4444;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-900">Damaged Assets</h1>
    <p class="text-gray-600 mt-1">Report and manage damaged assets</p>
</div>

<!-- Tab Navigation -->
<div class="mb-6">
    <div class="border-b border-gray-200">
        <nav class="-mb-px flex space-x-8">
            <button id="searchTab" class="tab-button active py-2 px-1 border-b-2 border-red-500 font-medium text-sm">
                <i class="fas fa-search mr-2"></i>Search Assets
            </button>
            <button id="logTab" class="tab-button py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm">
                <i class="fas fa-list mr-2"></i>Log Damaged Assets
            </button>
        </nav>
    </div>
</div>

<!-- Search Assets Tab -->
<div id="searchContent" class="tab-content">
    <!-- Filter Bar -->
    <div class="filter-bar rounded-lg p-6 mb-6">
        <h2 class="text-lg font-semibold mb-4">Find Asset to Report Damage</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium mb-2">Location</label>
                <select id="locationFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md text-gray-900 focus:outline-none focus:ring-2 focus:ring-red-500">
                    <option value="">Select Location</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Room</label>
                <select id="roomFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md text-gray-900 focus:outline-none focus:ring-2 focus:ring-red-500" disabled>
                    <option value="">Select Room</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Assets List -->
    <div id="assetsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6" style="display: none;">
        <!-- Assets will be populated here -->
    </div>
</div>

<!-- Log Damaged Assets Tab -->
<div id="logContent" class="tab-content" style="display: none;">
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">Damaged Assets Log</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asset</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Damage Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Severity</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reported By</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    </tr>
                </thead>
                <tbody id="damageLogTable" class="bg-white divide-y divide-gray-200">
                    <!-- Log entries will be populated here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Damage Report Modal -->
<div id="damageModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" style="display: none;">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Report Damage</h3>
                <button id="closeModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="damageForm">
                <input type="hidden" id="assetId" name="asset_id">
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Asset Name</label>
                    <input type="text" id="assetName" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100" readonly>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Damage Type *</label>
                    <select name="damage_type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500" required>
                        <option value="">Select Damage Type</option>
                        <option value="Physical Damage">Physical Damage</option>
                        <option value="Electrical Issue">Electrical Issue</option>
                        <option value="Software Problem">Software Problem</option>
                        <option value="Mechanical Failure">Mechanical Failure</option>
                        <option value="Water Damage">Water Damage</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Damage Description *</label>
                    <textarea name="damage_description" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Describe the damage in detail..." required></textarea>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Severity Level *</label>
                    <select name="severity" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500" required>
                        <option value="">Select Severity</option>
                        <option value="Low">Low - Minor issue, asset still usable</option>
                        <option value="Medium">Medium - Significant issue, limited functionality</option>
                        <option value="High">High - Major issue, asset unusable</option>
                        <option value="Critical">Critical - Safety hazard or complete failure</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Reported By *</label>
                    <input type="text" name="reported_by" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500" value="{{ user.username if user else '' }}" required>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Additional Notes</label>
                    <textarea name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Any additional information..."></textarea>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelBtn" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                        Submit Damage Report
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div id="successModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" style="display: none;">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/3 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                <i class="fas fa-check text-green-600 text-xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Report Submitted</h3>
            <p class="text-sm text-gray-500 mb-4">Your damage report has been submitted and is pending admin approval.</p>
            <button id="closeSuccessModal" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                OK
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Get real asset data from server
const assetsData = {{ assets_data | tojson }};

// Room reference data
let roomsData = {};
let allAssets = [];
let filteredAssets = [];

// Sample damage log data
let damageLog = [
    {id: 1, asset_name: "Laptop Dell XPS", damage_type: "Physical Damage", severity: "Medium", reported_by: "John Doe", date: "2024-01-15", status: "Pending Approval"},
    {id: 2, asset_name: "Office Chair", damage_type: "Mechanical Failure", severity: "Low", reported_by: "Jane Smith", date: "2024-01-14", status: "Approved"},
];

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Process asset data
    allAssets = assetsData.map(asset => ({
        id: asset.ID || asset.id,
        name: asset['Item Name'] || asset['Asset Name'] || asset.Name || 'Unnamed Asset',
        location: asset.Location || '',
        room: asset.Room || '',
        category: asset.Category || '',
        status: asset.Status || 'Active'
    })).filter(asset => asset.status === 'Active');
    
    buildRoomsData();
    initializeFilters();
    setupEventListeners();
    loadDamageLog();
});

function buildRoomsData() {
    roomsData = {};
    allAssets.forEach(asset => {
        if (asset.location && asset.room) {
            if (!roomsData[asset.location]) {
                roomsData[asset.location] = new Set();
            }
            roomsData[asset.location].add(asset.room);
        }
    });
    
    Object.keys(roomsData).forEach(location => {
        roomsData[location] = Array.from(roomsData[location]).sort();
    });
}

function initializeFilters() {
    const locationFilter = document.getElementById('locationFilter');
    const locations = [...new Set(allAssets.map(asset => asset.location))];
    
    locations.forEach(location => {
        const option = document.createElement('option');
        option.value = location;
        option.textContent = location;
        locationFilter.appendChild(option);
    });
}

function setupEventListeners() {
    // Tab switching
    document.getElementById('searchTab').addEventListener('click', () => switchTab('search'));
    document.getElementById('logTab').addEventListener('click', () => switchTab('log'));
    
    // Location filter
    document.getElementById('locationFilter').addEventListener('change', function() {
        const selectedLocation = this.value;
        const roomFilter = document.getElementById('roomFilter');
        
        roomFilter.innerHTML = '<option value="">Select Room</option>';
        roomFilter.disabled = !selectedLocation;
        
        if (selectedLocation && roomsData[selectedLocation]) {
            roomsData[selectedLocation].forEach(room => {
                const option = document.createElement('option');
                option.value = room;
                option.textContent = room;
                roomFilter.appendChild(option);
            });
            roomFilter.disabled = false;
        }
        
        filterAssets();
    });
    
    // Room filter
    document.getElementById('roomFilter').addEventListener('change', filterAssets);
    
    // Modal controls
    document.getElementById('closeModal').addEventListener('click', () => {
        document.getElementById('damageModal').style.display = 'none';
    });
    
    document.getElementById('cancelBtn').addEventListener('click', () => {
        document.getElementById('damageModal').style.display = 'none';
    });
    
    document.getElementById('closeSuccessModal').addEventListener('click', () => {
        document.getElementById('successModal').style.display = 'none';
        switchTab('log');
    });
    
    // Form submission
    document.getElementById('damageForm').addEventListener('submit', function(e) {
        e.preventDefault();
        submitDamageReport();
    });
}

function switchTab(tab) {
    const searchTab = document.getElementById('searchTab');
    const logTab = document.getElementById('logTab');
    const searchContent = document.getElementById('searchContent');
    const logContent = document.getElementById('logContent');
    
    if (tab === 'search') {
        searchTab.classList.add('active');
        logTab.classList.remove('active');
        searchContent.style.display = 'block';
        logContent.style.display = 'none';
    } else {
        logTab.classList.add('active');
        searchTab.classList.remove('active');
        logContent.style.display = 'block';
        searchContent.style.display = 'none';
        loadDamageLog();
    }
}

function filterAssets() {
    const locationFilter = document.getElementById('locationFilter').value;
    const roomFilter = document.getElementById('roomFilter').value;
    
    if (!locationFilter) {
        document.getElementById('assetsList').style.display = 'none';
        return;
    }
    
    filteredAssets = allAssets.filter(asset => {
        const matchesLocation = asset.location === locationFilter;
        const matchesRoom = !roomFilter || asset.room === roomFilter;
        return matchesLocation && matchesRoom;
    });
    
    displayAssets();
}

function displayAssets() {
    const assetsList = document.getElementById('assetsList');
    
    if (filteredAssets.length === 0) {
        assetsList.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">No assets found in selected location/room</div>';
        assetsList.style.display = 'block';
        return;
    }
    
    assetsList.innerHTML = filteredAssets.map(asset => `
        <div class="asset-card bg-white rounded-lg shadow p-4 border border-gray-200">
            <div class="flex justify-between items-start mb-2">
                <h3 class="font-medium text-gray-900">${asset.name}</h3>
                <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">${asset.status}</span>
            </div>
            <p class="text-sm text-gray-600 mb-1"><i class="fas fa-map-marker-alt mr-1"></i>${asset.location}</p>
            <p class="text-sm text-gray-600 mb-2"><i class="fas fa-door-open mr-1"></i>${asset.room}</p>
            <p class="text-sm text-gray-500 mb-3">${asset.category}</p>
            <button onclick="openDamageModal(${asset.id}, '${asset.name}')" class="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 text-sm">
                <i class="fas fa-exclamation-triangle mr-1"></i>Report Damage
            </button>
        </div>
    `).join('');
    
    assetsList.style.display = 'grid';
}

function openDamageModal(assetId, assetName) {
    document.getElementById('assetId').value = assetId;
    document.getElementById('assetName').value = assetName;
    document.getElementById('damageModal').style.display = 'block';
}

function submitDamageReport() {
    const formData = new FormData(document.getElementById('damageForm'));
    const assetName = document.getElementById('assetName').value;
    
    // Add to damage log
    const newEntry = {
        id: damageLog.length + 1,
        asset_name: assetName,
        damage_type: formData.get('damage_type'),
        severity: formData.get('severity'),
        reported_by: formData.get('reported_by'),
        date: new Date().toISOString().split('T')[0],
        status: 'Pending Approval'
    };
    
    damageLog.unshift(newEntry);
    
    // Close modal and show success
    document.getElementById('damageModal').style.display = 'none';
    document.getElementById('successModal').style.display = 'block';
}

function loadDamageLog() {
    const tableBody = document.getElementById('damageLogTable');
    
    if (damageLog.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No damage reports found</td></tr>';
        return;
    }
    
    tableBody.innerHTML = damageLog.map(entry => `
        <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${entry.asset_name}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${entry.damage_type}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getSeverityColor(entry.severity)}">${entry.severity}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${entry.reported_by}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${entry.date}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(entry.status)}">${entry.status}</span>
            </td>
        </tr>
    `).join('');
}

function getSeverityColor(severity) {
    switch(severity) {
        case 'Low': return 'bg-green-100 text-green-800';
        case 'Medium': return 'bg-yellow-100 text-yellow-800';
        case 'High': return 'bg-orange-100 text-orange-800';
        case 'Critical': return 'bg-red-100 text-red-800';
        default: return 'bg-gray-100 text-gray-800';
    }
}

function getStatusColor(status) {
    switch(status) {
        case 'Pending Approval': return 'bg-yellow-100 text-yellow-800';
        case 'Approved': return 'bg-green-100 text-green-800';
        case 'Rejected': return 'bg-red-100 text-red-800';
        default: return 'bg-gray-100 text-gray-800';
    }
}
</script>
{% endblock %}