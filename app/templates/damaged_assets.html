{% extends "layouts/modern_layout.html" %}

{% block title %}Asset Issue{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    .asset-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .asset-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    .filter-bar {
        background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
        color: white;
    }
    .tab-button {
        transition: all 0.2s ease;
    }
    .tab-button.active {
        background-color: #EF4444;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="mb-6 flex justify-between items-center">
    <div>
        <h1 class="text-2xl font-bold text-gray-900">Asset Issue Management</h1>
        <p class="text-gray-600 mt-1">Report and manage asset issues, repairs, and disposal</p>
    </div>
    <button onclick="refreshData()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
        <i class="fas fa-sync-alt mr-2"></i>Refresh Data
    </button>
</div>

<!-- Tab Navigation -->
<div class="mb-6">
    <div class="border-b border-gray-200">
        <nav class="-mb-px flex space-x-8">
            <button id="damageTab" class="tab-button active py-2 px-1 border-b-2 border-red-500 font-medium text-sm">
                <i class="fas fa-exclamation-triangle mr-2"></i>Report Damage
            </button>
            <button id="repairTab" class="tab-button py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm">
                <i class="fas fa-tools mr-2"></i>Report Repair
            </button>
            <button id="lostTab" class="tab-button py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm">
                <i class="fas fa-search mr-2"></i>Report Lost
            </button>
            <button id="disposalTab" class="tab-button py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm">
                <i class="fas fa-trash-alt mr-2"></i>Request Disposal
            </button>
        </nav>
    </div>
</div>

<!-- Report Damage Tab -->
<div id="damageContent" class="tab-content">
    <!-- Filter Bar -->
    <div class="filter-bar rounded-lg p-6 mb-6">
        <h2 class="text-lg font-semibold mb-4">Find Asset to Report Damage</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium mb-2">Location</label>
                <select id="locationFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md text-gray-900 focus:outline-none focus:ring-2 focus:ring-red-500">
                    <option value="">Select Location</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Room</label>
                <select id="roomFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md text-gray-900 focus:outline-none focus:ring-2 focus:ring-red-500" disabled>
                    <option value="">Select Room</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Assets List -->
    <div id="assetsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6" style="display: none;">
        <!-- Assets will be populated here -->
    </div>
</div>

<!-- Report Repair Tab -->
<div id="repairContent" class="tab-content" style="display: none;">
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">Assets Under Repair</h3>
            <p class="text-sm text-gray-500 mt-1">Manage assets currently being repaired</p>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asset Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Book Value</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="underRepairTable" class="bg-white divide-y divide-gray-200">
                    <!-- Under repair assets will be populated here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Report Lost Tab -->
<div id="lostContent" class="tab-content" style="display: none;">
    <!-- Search Bar -->
    <div class="bg-orange-600 rounded-lg p-6 mb-6 text-white">
        <h2 class="text-lg font-semibold mb-4">Find Asset to Report Lost</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium mb-2">Location</label>
                <select id="lostLocationFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500">
                    <option value="">Select Location</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Room</label>
                <select id="lostRoomFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md text-gray-900 focus:outline-none focus:ring-2 focus:ring-orange-500" disabled>
                    <option value="">Select Room</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Assets List for Lost Report -->
    <div id="lostAssetsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6" style="display: none;">
        <!-- Assets will be populated here -->
    </div>
</div>

<!-- Request Disposal Tab -->
<div id="disposalContent" class="tab-content" style="display: none;">
    <div class="bg-yellow-600 rounded-lg p-6 mb-6 text-white">
        <h2 class="text-lg font-semibold mb-4">Request Asset Disposal</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button id="disposalFromAssets" class="bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg p-4 text-left">
                <i class="fas fa-list mr-2"></i>
                <div>
                    <h3 class="font-medium">From Asset List</h3>
                    <p class="text-sm opacity-90">Select from all active assets</p>
                </div>
            </button>
            <button id="disposalFromDamaged" class="bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg p-4 text-left">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                <div>
                    <h3 class="font-medium">From Damaged Assets</h3>
                    <p class="text-sm opacity-90">Select from damaged assets</p>
                </div>
            </button>
        </div>
    </div>

    <!-- Disposal Assets List -->
    <div id="disposalAssetsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6" style="display: none;">
        <!-- Assets will be populated here -->
    </div>
</div>

<!-- Damage Report Modal -->
<div id="damageModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" style="display: none;">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Report Damage</h3>
                <button id="closeModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="damageForm">
                <input type="hidden" id="assetId" name="asset_id">
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Asset Name</label>
                    <input type="text" id="assetName" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100" readonly>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Damage Type *</label>
                    <select name="damage_type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500" required>
                        <option value="">Select Damage Type</option>
                        <option value="Physical Damage">Physical Damage</option>
                        <option value="Electrical Issue">Electrical Issue</option>
                        <option value="Software Problem">Software Problem</option>
                        <option value="Mechanical Failure">Mechanical Failure</option>
                        <option value="Water Damage">Water Damage</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Damage Description *</label>
                    <textarea name="damage_description" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Describe the damage in detail..." required></textarea>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Severity Level *</label>
                    <select name="severity" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500" required>
                        <option value="">Select Severity</option>
                        <option value="Low">Low - Minor issue, asset still usable</option>
                        <option value="Medium">Medium - Significant issue, limited functionality</option>
                        <option value="High">High - Major issue, asset unusable</option>
                        <option value="Critical">Critical - Safety hazard or complete failure</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Reported By *</label>
                    <input type="text" name="reported_by" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500" value="{{ user.username if user else '' }}" required>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Additional Notes</label>
                    <textarea name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Any additional information..."></textarea>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelBtn" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                        Submit Damage Report
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Repair Action Modal -->
<div id="repairActionModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" style="display: none;">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Repair Action</h3>
                <button id="closeRepairModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="mb-4">
                <p class="text-sm text-gray-600 mb-4">Choose repair action for: <span id="repairAssetName" class="font-medium"></span></p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button id="storeAssetBtn" class="p-4 border-2 border-blue-200 rounded-lg hover:border-blue-400 text-left">
                        <i class="fas fa-warehouse text-blue-600 mb-2"></i>
                        <h4 class="font-medium text-gray-900">Store Asset</h4>
                        <p class="text-sm text-gray-500">Move to storage facility</p>
                    </button>
                    
                    <button id="allocateAssetBtn" class="p-4 border-2 border-green-200 rounded-lg hover:border-green-400 text-left">
                        <i class="fas fa-map-marker-alt text-green-600 mb-2"></i>
                        <h4 class="font-medium text-gray-900">Allocate Asset</h4>
                        <p class="text-sm text-gray-500">Assign to new location</p>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Allocate Asset Modal -->
<div id="allocateModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" style="display: none;">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Allocate Asset</h3>
                <button id="closeAllocateModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="allocateForm">
                <input type="hidden" id="allocateAssetId">
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Business Unit *</label>
                    <select id="businessUnitSelect" name="business_unit" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" required>
                        <option value="">Select Business Unit</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Location *</label>
                    <select id="allocateLocation" name="location" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" required>
                        <option value="">Select Location</option>
                    </select>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Room *</label>
                    <select id="allocateRoom" name="room" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" disabled required>
                        <option value="">Select Room</option>
                    </select>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelAllocateBtn" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                        Submit Allocation
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Lost Report Modal -->
<div id="lostModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" style="display: none;">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Report Lost Asset</h3>
                <button id="closeLostModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="lostForm">
                <input type="hidden" id="lostAssetId">
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Asset Name</label>
                    <input type="text" id="lostAssetName" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100" readonly>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Last Known Location</label>
                    <input type="text" name="last_location" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" required>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date Lost *</label>
                    <input type="date" name="date_lost" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" required>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description *</label>
                    <textarea name="description" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Describe circumstances of loss..." required></textarea>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelLostBtn" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700">
                        Report Lost
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div id="successModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" style="display: none;">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/3 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                <i class="fas fa-check text-green-600 text-xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Request Submitted</h3>
            <p class="text-sm text-gray-500 mb-4">Your request has been submitted and is pending admin approval.</p>
            <button id="closeSuccessModal" class="px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700">
                OK
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Get real asset data from server
const assetsData = {{ assets_data | tojson }};

// Room reference data
let roomsData = {};
let allAssets = [];
let filteredAssets = [];

// Get damage log and under repair assets from real data
let damageLog = [];
let underRepairAssets = [];

// Process real asset data to find damaged and under repair assets
function processAssetData() {

    
    // Filter assets with status "Under Repair" only
    underRepairAssets = allAssets.filter(asset => {
        const status = (asset.Status || asset.status || '').toString().trim();

        return status === 'Under Repair';
    }).map(asset => ({
        id: asset.ID,  // Use ID column from Assets sheet
        asset_name: asset['Item Name'],
        location: asset.Location,
        room: asset.Room,
        category: asset.Category,
        book_value: parseFloat(asset['Book Value'] || 0),
        damage_type: asset['Item Condition'] || 'Not specified',
        severity: 'Medium',
        repair_date: asset['Purchase Date'] || new Date().toISOString().split('T')[0]
    }));
    

    
    // Create damage log from all non-active assets
    damageLog = allAssets.filter(asset => {
        const status = (asset.Status || asset.status || '').toString().trim();
        return ['Under Repair', 'To be Disposed', 'Disposed', 'In Storage'].includes(status);
    }).map((asset, index) => ({
        id: index + 1,
        asset_name: asset.name,
        damage_type: 'System Generated',
        severity: 'Medium',
        reported_by: 'System',
        date: new Date().toISOString().split('T')[0],
        status: asset.Status || asset.status
    }));
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Process all asset data (don't filter by status here)
    allAssets = assetsData.map(asset => ({
        id: asset.ID,  // Use ID column from Assets sheet
        name: asset['Item Name'] || asset['Asset Name'] || asset.Name || 'Unnamed Asset',
        location: asset.Location || '',
        room: asset.Room || '',
        category: asset.Category || '',
        status: asset.Status || 'Active',
        Status: asset.Status || 'Active',
        'Item Name': asset['Item Name'] || asset.name,
        Location: asset.Location || '',
        Room: asset.Room || '',
        Category: asset.Category || '',
        'Book Value': asset['Book Value'] || 0,
        'Item Condition': asset['Item Condition'] || '',
        'Purchase Date': asset['Purchase Date'] || ''
    }));
    
    // Filter active assets for damage reporting
    const activeAssets = allAssets.filter(asset => asset.status === 'Active');
    
    buildRoomsData();
    processAssetData();
    initializeFilters();
    setupEventListeners();
    loadDamageLog();
    loadUnderRepairAssets();
    loadBusinessUnits();
    
    // Use active assets for damage reporting
    allAssets = activeAssets;
});

function buildRoomsData() {
    roomsData = {};
    allAssets.forEach(asset => {
        if (asset.location && asset.room) {
            if (!roomsData[asset.location]) {
                roomsData[asset.location] = new Set();
            }
            roomsData[asset.location].add(asset.room);
        }
    });
    
    Object.keys(roomsData).forEach(location => {
        roomsData[location] = Array.from(roomsData[location]).sort();
    });
}

function initializeFilters() {
    const locationFilter = document.getElementById('locationFilter');
    const lostLocationFilter = document.getElementById('lostLocationFilter');
    const locations = [...new Set(allAssets.map(asset => asset.location))];
    
    // Populate damage report location filter
    locations.forEach(location => {
        const option = document.createElement('option');
        option.value = location;
        option.textContent = location;
        locationFilter.appendChild(option);
    });
    
    // Populate lost report location filter
    locations.forEach(location => {
        const option = document.createElement('option');
        option.value = location;
        option.textContent = location;
        lostLocationFilter.appendChild(option);
    });
}

function setupEventListeners() {
    // Tab switching
    document.getElementById('damageTab').addEventListener('click', () => switchTab('damage'));
    document.getElementById('repairTab').addEventListener('click', () => switchTab('repair'));
    document.getElementById('lostTab').addEventListener('click', () => switchTab('lost'));
    document.getElementById('disposalTab').addEventListener('click', () => switchTab('disposal'));
    
    // Location filter for damage tab
    document.getElementById('locationFilter').addEventListener('change', function() {
        const selectedLocation = this.value;
        const roomFilter = document.getElementById('roomFilter');
        
        roomFilter.innerHTML = '<option value="">Select Room</option>';
        roomFilter.disabled = !selectedLocation;
        
        if (selectedLocation && roomsData[selectedLocation]) {
            roomsData[selectedLocation].forEach(room => {
                const option = document.createElement('option');
                option.value = room;
                option.textContent = room;
                roomFilter.appendChild(option);
            });
            roomFilter.disabled = false;
        }
        
        filterAssets();
    });
    
    // Room filter for damage tab
    document.getElementById('roomFilter').addEventListener('change', filterAssets);
    
    // Lost report filters
    document.getElementById('lostLocationFilter').addEventListener('change', function() {
        const selectedLocation = this.value;
        const roomFilter = document.getElementById('lostRoomFilter');
        
        roomFilter.innerHTML = '<option value="">Select Room</option>';
        roomFilter.disabled = !selectedLocation;
        
        if (selectedLocation && roomsData[selectedLocation]) {
            roomsData[selectedLocation].forEach(room => {
                const option = document.createElement('option');
                option.value = room;
                option.textContent = room;
                roomFilter.appendChild(option);
            });
            roomFilter.disabled = false;
        }
        
        filterLostAssets();
    });
    
    // Room filter for lost tab
    document.getElementById('lostRoomFilter').addEventListener('change', filterLostAssets);
    
    // Modal controls
    document.getElementById('closeModal').addEventListener('click', () => {
        document.getElementById('damageModal').style.display = 'none';
    });
    
    document.getElementById('cancelBtn').addEventListener('click', () => {
        document.getElementById('damageModal').style.display = 'none';
    });
    
    document.getElementById('closeSuccessModal').addEventListener('click', () => {
        document.getElementById('successModal').style.display = 'none';
        switchTab('log');
    });
    
    // Form submission
    document.getElementById('damageForm').addEventListener('submit', function(e) {
        e.preventDefault();
        submitDamageReport();
    });
    
    // Direct damage report form submission
    document.getElementById('directDamageForm').addEventListener('submit', function(e) {
        e.preventDefault();
        submitDirectDamageReport();
    });
}

function switchTab(tab) {
    const damageTab = document.getElementById('damageTab');
    const repairTab = document.getElementById('repairTab');
    const lostTab = document.getElementById('lostTab');
    const disposalTab = document.getElementById('disposalTab');
    const damageContent = document.getElementById('damageContent');
    const repairContent = document.getElementById('repairContent');
    const lostContent = document.getElementById('lostContent');
    const disposalContent = document.getElementById('disposalContent');
    
    // Remove active class from all tabs
    [damageTab, repairTab, lostTab, disposalTab].forEach(t => t.classList.remove('active'));
    [damageContent, repairContent, lostContent, disposalContent].forEach(c => c.style.display = 'none');
    
    if (tab === 'damage') {
        damageTab.classList.add('active');
        damageContent.style.display = 'block';
    } else if (tab === 'repair') {
        repairTab.classList.add('active');
        repairContent.style.display = 'block';
        loadUnderRepairAssets();
    } else if (tab === 'lost') {
        lostTab.classList.add('active');
        lostContent.style.display = 'block';
    } else if (tab === 'disposal') {
        disposalTab.classList.add('active');
        disposalContent.style.display = 'block';
    }
}

function filterAssets() {
    const locationFilter = document.getElementById('locationFilter').value;
    const roomFilter = document.getElementById('roomFilter').value;
    
    if (!locationFilter) {
        document.getElementById('assetsList').style.display = 'none';
        return;
    }
    
    filteredAssets = allAssets.filter(asset => {
        const matchesLocation = asset.location === locationFilter;
        const matchesRoom = !roomFilter || asset.room === roomFilter;
        return matchesLocation && matchesRoom;
    });
    
    displayAssets();
}

function displayAssets() {
    const assetsList = document.getElementById('assetsList');
    
    if (filteredAssets.length === 0) {
        assetsList.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">No assets found in selected location/room</div>';
        assetsList.style.display = 'block';
        return;
    }
    
    assetsList.innerHTML = filteredAssets.map(asset => `
        <div class="asset-card bg-white rounded-lg shadow p-4 border border-gray-200">
            <div class="flex justify-between items-start mb-2">
                <h3 class="font-medium text-gray-900">${asset.name}</h3>
                <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">${asset.status}</span>
            </div>
            <p class="text-sm text-gray-600 mb-1"><i class="fas fa-map-marker-alt mr-1"></i>${asset.location}</p>
            <p class="text-sm text-gray-600 mb-2"><i class="fas fa-door-open mr-1"></i>${asset.room}</p>
            <p class="text-sm text-gray-500 mb-3">${asset.category}</p>
            <p class="text-xs text-gray-400 mb-2">ID: ${asset.id}</p>
            <button onclick="openDamageModal(${asset.id}, '${asset.name}')" class="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 text-sm">
                <i class="fas fa-exclamation-triangle mr-1"></i>Report Damage
            </button>
        </div>
    `).join('');
    
    assetsList.style.display = 'grid';
}

function openDamageModal(assetId, assetName) {
    document.getElementById('assetId').value = assetId;
    document.getElementById('assetName').value = assetName;
    document.getElementById('damageModal').style.display = 'block';
}

async function submitDamageReport() {
    const formData = new FormData(document.getElementById('damageForm'));
    const assetId = document.getElementById('assetId').value;
    const assetName = document.getElementById('assetName').value;
    
    // Create damage report data
    const damageReport = {
        asset_id: assetId,
        asset_name: assetName,
        damage_type: formData.get('damage_type'),
        damage_description: formData.get('damage_description'),
        severity: formData.get('severity'),
        reported_by: formData.get('reported_by'),
        notes: formData.get('notes')
    };
    
    try {
        // Submit to server (will sync to Google Sheets)
        const response = await fetch('/damage/report', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(damageReport)
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            // Close modal and show success
            document.getElementById('damageModal').style.display = 'none';
            document.getElementById('successModal').style.display = 'block';
            
            // Refresh data
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            alert('Error submitting damage report: ' + result.message);
        }
    } catch (error) {
        alert('Error submitting damage report: ' + error.message);
    }
}

function approveDamageReport(damageReport) {
    // Find the asset in allAssets and update it
    const assetIndex = allAssets.findIndex(asset => asset.id == damageReport.asset_id);
    
    if (assetIndex !== -1) {
        // Update asset status and move to storage
        allAssets[assetIndex].Status = 'Under Repair';
        allAssets[assetIndex].status = 'Under Repair';
        allAssets[assetIndex].Location = 'HO - Ciputat';
        allAssets[assetIndex].location = 'HO - Ciputat';
        allAssets[assetIndex].Room = '1022 - Gudang Support TOG';
        allAssets[assetIndex].room = '1022 - Gudang Support TOG';
        
        // Update damage log status
        const logEntry = damageLog.find(entry => entry.asset_name === damageReport.asset_name);
        if (logEntry) {
            logEntry.status = 'Approved';
        }
        
        // Refresh data
        processAssetData();
        
        // Show notification
        showToast(`Damage report approved. ${damageReport.asset_name} moved to storage and status changed to Under Repair.`, 'green');
        
        console.log(`Asset ${damageReport.asset_name} approved: Status=Under Repair, Location=HO - Ciputat, Room=1022 - Gudang Support TOG`);
    }
}

function loadDamageLog() {
    const tableBody = document.getElementById('damageLogTable');
    
    if (damageLog.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No damage reports found</td></tr>';
        return;
    }
    
    tableBody.innerHTML = damageLog.map(entry => `
        <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${entry.asset_name}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${entry.damage_type}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getSeverityColor(entry.severity)}">${entry.severity}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${entry.reported_by}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${entry.date}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(entry.status)}">${entry.status}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${entry.status === 'Approved' ? `
                    <button onclick="markAsDisposed(${entry.id})" class="text-yellow-600 hover:text-yellow-900 mr-2" title="Mark as To Be Disposed">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                ` : ''}
            </td>
        </tr>
    `).join('');
}

function getSeverityColor(severity) {
    switch(severity) {
        case 'Low': return 'bg-green-100 text-green-800';
        case 'Medium': return 'bg-yellow-100 text-yellow-800';
        case 'High': return 'bg-orange-100 text-orange-800';
        case 'Critical': return 'bg-red-100 text-red-800';
        default: return 'bg-gray-100 text-gray-800';
    }
}

function getStatusColor(status) {
    switch(status) {
        case 'Pending Approval': return 'bg-yellow-100 text-yellow-800';
        case 'Approved': return 'bg-green-100 text-green-800';
        case 'Rejected': return 'bg-red-100 text-red-800';
        default: return 'bg-gray-100 text-gray-800';
    }
}

function submitDirectDamageReport() {
    const formData = new FormData(document.getElementById('directDamageForm'));
    const assetIdentifier = formData.get('asset_identifier');
    
    // Find asset by name or ID
    const asset = allAssets.find(a => 
        a.name === assetIdentifier || 
        a.id == assetIdentifier ||
        (a['Item Name'] && a['Item Name'] === assetIdentifier)
    );
    
    if (!asset) {
        alert('Asset not found. Please check the asset ID/name.');
        return;
    }
    
    // Create damage report
    const damageReport = {
        asset_id: asset.id,
        asset_name: asset.name,
        damage_type: formData.get('damage_type'),
        damage_description: formData.get('damage_description'),
        severity: formData.get('severity'),
        reported_by: formData.get('reported_by'),
        notes: formData.get('notes'),
        date: new Date().toISOString().split('T')[0],
        status: 'Pending Approval'
    };
    
    // Add to damage log
    damageLog.unshift({
        id: damageLog.length + 1,
        asset_name: asset.name,
        damage_type: damageReport.damage_type,
        severity: damageReport.severity,
        reported_by: damageReport.reported_by,
        date: damageReport.date,
        status: 'Pending Approval'
    });
    
    // Simulate admin approval
    setTimeout(() => {
        approveDamageReport(damageReport);
    }, 2000);
    
    // Reset form and show success
    document.getElementById('directDamageForm').reset();
    document.getElementById('successModal').style.display = 'block';
}

function markAsDisposed(entryId) {
    if (confirm('Mark this asset as "To Be Disposed"? This action will require admin approval.')) {
        // Find the entry and update status
        const entry = damageLog.find(e => e.id === entryId);
        if (entry) {
            entry.status = 'To Be Disposed';
            loadDamageLog();
            
            // Show notification
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 bg-yellow-600 text-white px-4 py-2 rounded shadow-lg z-50';
            toast.innerHTML = '<i class="fas fa-info-circle mr-2"></i>Asset marked for disposal - pending admin approval';
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    }
}

function loadUnderRepairAssets() {
    const tableBody = document.getElementById('underRepairTable');
    
    if (underRepairAssets.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No assets under repair</td></tr>';
        return;
    }
    
    tableBody.innerHTML = underRepairAssets.map(asset => `
        <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                ${asset.asset_name}
                <div class="text-xs text-gray-400">ID: ${asset.id}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${asset.location}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${asset.category}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${asset.book_value.toLocaleString()}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                <div class="flex space-x-2">
                    <button onclick="viewAssetDetail(${asset.id})" class="text-blue-600 hover:text-blue-900" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button onclick="openRepairAction(${asset.id}, '${asset.asset_name}')" class="text-green-600 hover:text-green-900" title="Repair Action">
                        <i class="fas fa-tools"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function viewAssetDetail(assetId) {
    const asset = underRepairAssets.find(a => a.id === assetId);
    if (asset) {
        alert(`Asset Details:\nName: ${asset.asset_name}\nLocation: ${asset.location}\nDamage: ${asset.damage_type}\nSeverity: ${asset.severity}`);
    }
}

function markAsFixed(assetId) {
    if (confirm('Mark this asset as Fixed? This will change status to Active.')) {
        // Remove from under repair list
        underRepairAssets = underRepairAssets.filter(a => a.id !== assetId);
        loadUnderRepairAssets();
        
        showToast('Asset marked as Fixed and returned to Active status', 'green');
    }
}

function markForDisposal(assetId) {
    if (confirm('Mark this asset for Disposal? This action requires admin approval.')) {
        // Remove from under repair list
        const asset = underRepairAssets.find(a => a.id === assetId);
        underRepairAssets = underRepairAssets.filter(a => a.id !== assetId);
        loadUnderRepairAssets();
        
        showToast('Asset marked for disposal - pending admin approval', 'yellow');
    }
}

function openRepairAction(assetId, assetName) {
    document.getElementById('repairAssetName').textContent = assetName;
    document.getElementById('repairActionModal').style.display = 'block';
    
    // Store asset info for later use
    window.currentRepairAsset = { id: assetId, name: assetName };
}

// Add event listeners for repair action modal
document.addEventListener('DOMContentLoaded', function() {
    // Repair modal controls
    document.getElementById('closeRepairModal').addEventListener('click', () => {
        document.getElementById('repairActionModal').style.display = 'none';
    });
    
    document.getElementById('storeAssetBtn').addEventListener('click', () => {
        submitRepairAction('store');
    });
    
    document.getElementById('allocateAssetBtn').addEventListener('click', () => {
        document.getElementById('repairActionModal').style.display = 'none';
        document.getElementById('allocateAssetId').value = window.currentRepairAsset.id;
        document.getElementById('allocateModal').style.display = 'block';
    });
    
    // Allocate modal controls
    document.getElementById('closeAllocateModal').addEventListener('click', () => {
        document.getElementById('allocateModal').style.display = 'none';
    });
    
    document.getElementById('cancelAllocateBtn').addEventListener('click', () => {
        document.getElementById('allocateModal').style.display = 'none';
    });
    
    document.getElementById('allocateForm').addEventListener('submit', function(e) {
        e.preventDefault();
        submitAllocation();
    });
});

async function submitRepairAction(actionType) {
    const asset = window.currentRepairAsset;
    
    if (actionType === 'store') {
        if (!confirm('Are you sure you want to STORE this asset? This will move the asset to storage and require admin approval.')) {
            return;
        }
    }
    
    const repairData = {
        asset_id: asset.id,
        asset_name: asset.name,
        action_type: actionType,
        description: actionType === 'store' ? 'Request to store asset after repair completion' : 'Asset allocated to new location'
    };
    
    try {
        const response = await fetch('/repair/action', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(repairData)
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            document.getElementById('repairActionModal').style.display = 'none';
            showToast(result.message, 'green');
            
            // Refresh page to show updated data
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        alert('Error submitting repair action: ' + error.message);
    }
}

async function submitAllocation() {
    const formData = new FormData(document.getElementById('allocateForm'));
    const asset = window.currentRepairAsset;
    
    const allocationData = {
        asset_id: asset.id,
        asset_name: asset.name,
        action_type: 'allocate',
        business_unit: formData.get('business_unit'),
        location: formData.get('location'),
        room: formData.get('room'),
        description: `Asset allocated to ${formData.get('location')} - ${formData.get('room')}`
    };
    
    try {
        const response = await fetch('/repair/action', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(allocationData)
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            document.getElementById('allocateModal').style.display = 'none';
            showToast(result.message, 'green');
            
            // Refresh page to show updated data
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        alert('Error submitting allocation: ' + error.message);
    }
}

function filterLostAssets() {
    const locationFilter = document.getElementById('lostLocationFilter').value;
    const roomFilter = document.getElementById('lostRoomFilter').value;
    
    if (!locationFilter) {
        document.getElementById('lostAssetsList').style.display = 'none';
        return;
    }
    
    const filteredAssets = allAssets.filter(asset => {
        const matchesLocation = asset.location === locationFilter;
        const matchesRoom = !roomFilter || asset.room === roomFilter;
        return matchesLocation && matchesRoom;
    });
    
    displayLostAssets(filteredAssets);
}

function displayLostAssets(assets) {
    const assetsList = document.getElementById('lostAssetsList');
    
    if (assets.length === 0) {
        assetsList.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">No assets found in selected location/room</div>';
        assetsList.style.display = 'block';
        return;
    }
    
    assetsList.innerHTML = assets.map(asset => `
        <div class="asset-card bg-white rounded-lg shadow p-4 border border-gray-200">
            <div class="flex justify-between items-start mb-2">
                <h3 class="font-medium text-gray-900">${asset.name}</h3>
                <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">${asset.status}</span>
            </div>
            <p class="text-sm text-gray-600 mb-1"><i class="fas fa-map-marker-alt mr-1"></i>${asset.location}</p>
            <p class="text-sm text-gray-600 mb-2"><i class="fas fa-door-open mr-1"></i>${asset.room}</p>
            <p class="text-sm text-gray-500 mb-3">${asset.category}</p>
            <p class="text-xs text-gray-400 mb-2">ID: ${asset.id}</p>
            <button onclick="openLostModal(${asset.id}, '${asset.name}', '${asset.location}')" class="w-full bg-orange-600 text-white py-2 px-4 rounded-md hover:bg-orange-700 text-sm">
                <i class="fas fa-search mr-1"></i>Report Lost
            </button>
        </div>
    `).join('');
    
    assetsList.style.display = 'grid';
}

function openLostModal(assetId, assetName, lastLocation) {
    document.getElementById('lostAssetId').value = assetId;
    document.getElementById('lostAssetName').value = assetName;
    document.querySelector('input[name="last_location"]').value = lastLocation;
    document.getElementById('lostModal').style.display = 'block';
}

function refreshData() {
    showToast('Refreshing data...', 'blue');
    setTimeout(() => {
        location.reload();
    }, 1000);
}

function loadBusinessUnits() {
    // Load business units from template data
    const dropdownOptions = {{ dropdown_options | tojson }};
    const select = document.getElementById('businessUnitSelect');
    
    if (dropdownOptions && dropdownOptions.business_units) {
        dropdownOptions.business_units.forEach(unit => {
            const option = document.createElement('option');
            option.value = unit;
            option.textContent = unit;
            select.appendChild(option);
        });
    }
}

function showToast(message, color) {
    const colorClasses = {
        green: 'bg-green-600',
        yellow: 'bg-yellow-600',
        red: 'bg-red-600',
        blue: 'bg-blue-600'
    };
    
    const toast = document.createElement('div');
    toast.className = `fixed bottom-4 right-4 ${colorClasses[color]} text-white px-4 py-2 rounded shadow-lg z-50`;
    toast.innerHTML = `<i class="fas fa-info-circle mr-2"></i>${message}`;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}
</script>
{% endblock %}